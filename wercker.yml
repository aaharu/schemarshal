box: alexeiled/go-builder
build:
  steps:
    - setup-go-workspace

    # Gets the dependencies
    - script:
        name: glide install
        code: |
          glide install

    # Build the project
    - script:
        name: go build
        code: |
          go build $(glide novendor)

    # Test the project
    - script:
        name: go test and goveralls
        code: |
          echo "mode: count" > c.out
          for pkg in $(glide novendor); do
            go test -v -covermode=count -coverprofile="pkg.out" "${pkg}"
            if [ -f "pkg.out" ]; then
              tail -n +2 "pkg.out" >> c.out
              rm pkg.out
            fi
          done
          GIT_BRANCH="${WERCKER_GIT_BRANCH}" goveralls -v -coverprofile=c.out -service=wercker.com -repotoken "${COVERALLS_TOKEN}"

    # corros compile
    - tcnksm/gox:
        os: "darwin linux windows freebsd netbsd"
        arch: "amd64"

    - script:
        name: output release tag
        code: |
          fgrep 'const Version' "${WERCKER_SOURCE_DIR}/version/version.go" | cut -f4 -d ' ' | tr -d '"' > "${WERCKER_OUTPUT_DIR}/tag.out"

deploy:
  steps:
    - script:
        name: restore release tag
        code: |
          if [ $(fgrep -c "## [Unreleased]" CHANGELOG.md) -eq 1 ]; then
            exit 1
          fi
          export RELEASE_TAG=$(cat tag.out)

    - script:
        name: github release
        code: |
          git tag "${RELEASE_TAG}" && git push --tags
          github-release release --user aaharu --repo schemarshal --tag "${RELEASE_TAG}"
          github-release upload --user aaharu --repo schemarshal --tag "${RELEASE_TAG}" --file pkg/darwin_amd64/schemarshal
          github-release upload --user aaharu --repo schemarshal --tag "${RELEASE_TAG}" --file pkg/linux_amd64/schemarshal
          github-release upload --user aaharu --repo schemarshal --tag "${RELEASE_TAG}" --file pkg/windows_amd64/schemarshal.exe
          github-release upload --user aaharu --repo schemarshal --tag "${RELEASE_TAG}" --file pkg/freebsd_amd64/schemarshal
          github-release upload --user aaharu --repo schemarshal --tag "${RELEASE_TAG}" --file pkg/netbsd_amd64/schemarshal
